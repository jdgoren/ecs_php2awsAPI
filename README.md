Using AWS Lambda,AWS API Gateway and ECS (Docker Microservice) (HMAC signature for Apigee Oauth endpoint)
Summary:
The point of this document is to highlight and show what I learned at AWS Reinvent 2015. I have used 3 new services provided by AWS in a example of how Autodesk architects can tie together these services. I had a requirement to create a simple way to generate a HMAC signature from multiple variables for Product Owners and Business Analysts without having to run scripts manually. First we have a Lambda function in python that takes in the parameters and calculates the signature and returns it as part of the response. Next, we enabled an API endpoint to invoke this function via a REST POST call. Third, we created a Dockerimage of a PHP application that invokes this service via a web form submission that is hosted on Amazon ECS (backed by Amazon EC2). Please reach out to jacob.goren@autodesk.com for any questions.


  


•	Go to AWS Lambda and create a function
•	Choose the name and language type. I have chosen python.
•	Add an IAM role that has permissions to do what is needed in the script. This script only needs lambda, but I have a user that can also read/write to dyanmo
•	Click next and see your function created 
o	Lambda code (Python)
•	Click on actions to configure a sample event.
•	Fill in the sample event with a static payload
•	After testing, you should see a response & status
•	Now setup the API endpoint with the API endpoints tab
•	Click "Add API endpoint"
•	Choose the names and methods and security. It is not recommended to have it open. Open is just for testing purposes.
•	Submit and see your new endpoint for the lambda function
•	Create an API key and associate it to your method and make sure it is required & redeploy
•	Create two simple PHP pages to represent a application you want to run as your microservice 
o	index.php
o	lambdasubmit.php
•	Create your docker build file. This file starts with ubuntu, adds a LAMP stack and then copies our sample PHP application into the server and has it start on launch.
•	Build your docker image
•	See your images locally
•	Log into docker
•	Push your image to dockerhub
•	See your image in dockerhub
•	Go to ECS AWS console & start a cluster
•	When you get to the IAM role section, create new roles for ECS
•	Create an EC2 and ECS role as: ecsInstanceRole & ecsService Role (Autogenerated)
•	Use the new roles you created
•	Have the console launch your ECS cluster via cloudformation
•	After the cluster is launched list out our clusters on your command line.
•	Get the available instances from the cluster (Sample cluster only had one micro ec2 instance)
•	Deploy your ecs task
•	View the output and check if the task is available in the console.
•	Go to your clusters on ECS
•	Click Run new Task
•	Choose the task definition you just created and click Run Task
•	See your task spinning up
•	Get the IP of your microservice to see your application
•	View our sample application
•	Fill in the paramaters and click Submit
•	View the result of the PHP application which submitted the parameters to the AWS API endpoint which invoked our Python logic in our AWS Lambda function.
Go to AWS Lambda and create a function
 
 
Choose the name and language type. I have chosen python.
 
 
 
 
Add an IAM role that has permissions to do what is needed in the script. This script only needs lambda, but I have a user that can also read/write to dyanmo
 
Click next and see your function created
 
Lambda code (Python)
import json
import re
import calendar
from base64 import b64encode
from datetime import timedelta , datetime
from hmac import HMAC
import sys, os, base64, hashlib, hmac 
import time
print('Loading function')

def lambda_handler(event, context):
    print("callback = " + event['callback'])
    print("clientsecret = " + event['clientsecret'])
    print("clientid = " + event['clientid'])
    calculated_time_stamp = calendar.timegm(time.gmtime())
    print (calculated_time_stamp)
    hmacString = str(event['clientsecret'])+ str(event['callback']) + str(event['clientid']) + str(calculated_time_stamp)
    print (hmacString)
    generated_signature_oauth = base64.b64encode(hmac.new(str(event['clientsecret']),hmacString, hashlib.sha256).digest())
    data = {}
    data['callback'] = str(event['callback'])
    data['clientsecret'] = str(event['clientsecret'])
    data['clientid'] = str(event['clientid'])
    data['timestamp'] = str(calculated_time_stamp)
    data['signature'] = generated_signature_oauth
    return data  
    raise Exception('Something went wrong')
Click on actions to configure a sample event.
 
Fill in the sample event with a static payload
 
{
  "callback": "https://apoorva.com",
  "clientsecret": "S6meLXlUY00YVML3",
  "clientid": "LfmvNs1g14p0C7AR3IKyfoCxO6i2zKAJ"
}
After testing, you should see a response & status
 
Now setup the API endpoint with the API endpoints tab
 
Click "Add API endpoint"
 
Choose the names and methods and security. It is not recommended to have it open. Open is just for testing purposes.
 
Submit and see your new endpoint for the lambda function
 
Create an API key and associate it to your method and make sure it is required & redeploy
 
 
 
 
 
 
 
{
  "callback": "https://apoorva.com",
  "timestamp": "1444762678",
  "signature": "WRfKcxY3ddRv/mi8gi1OaU4Yd+yVL+L8tbwjqP8bMlQ=",
  "clientid": "LfmvNs1g14p0C7AR3IKyfoCxO6i2zKAJ",
  "clientsecret": "S6meLXlUY00YVML3"
}
Create two simple PHP pages to represent a application you want to run as your microservice
index.php
<html>
 <head>
  <title>ECS Docker Lambda Test</title>
 </head>
 <body>
 <?php echo '<p>ECS Docker Lambda Test By Jacob Goren</p>'; ?> 
 <form action="lambdasubmit.php" method="post">
Callback: <input type="text" name="Callback"><br>
ClientID: <input type="text" name="ClientID"><br>
ClientSecret: <input type="text" name="ClientSecret"><br>
<input type="submit">
</form>
 </body>
</html>
lambdasubmit.php
<?php
$data = array("callback" => $_POST["Callback"], "clientid" => $_POST["ClientID"], "clientsecret" => $_POST["ClientSecret"]);
$data_string = json_encode($data);
$ch = curl_init('https://m1g1mqu433.execute-api.us-east-1.amazonaws.com/prod/HMAC-Gen-For-Apigee-Lambda-Sample');                                                                      
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, array('x-api-key: pxovgQymYq7ezElYiHDpeaXM4x98DbqaMacpEIG2'));
$result = curl_exec($ch);
print $result
?>
 
Create your docker build file. This file starts with ubuntu, adds a LAMP stack and then copies our sample PHP application into the server and has it start on launch.
FROM ubuntu:14.04
MAINTAINER Jacob Goren <jacob.goren@autoesk.com>
VOLUME ["/var/www"]
RUN apt-get update
RUN apt-get upgrade -y
RUN apt-get install -y openssh-server apache2 supervisor php5 php5-cli libapache2-mod-php5 php5-gd php5-json php5-ldap php5-mysql php5-pgsql
RUN apt-get install -y git 
RUN apt-get install -y php5-curl
RUN apt-get install -y curl
RUN apt-get install -y nano
RUN mkdir -p /var/run/sshd
RUN mkdir -p /var/log/supervisor
RUN useradd ubuntu -d /home/ubuntu
RUN mkdir -p /home/ubuntu/.ssh
RUN chmod 700 /home/ubuntu/.ssh
RUN chown ubuntu:ubuntu /home/ubuntu/.ssh
RUN rm -rf /var/www/*
ADD ecs_php2awsAPI /var/www

ADD apache_default /etc/apache2/sites-available/000-default.conf
RUN a2enmod rewrite
RUN sed -ri 's/^display_errors\s*=\s*Off/display_errors = On/g' /etc/php5/apache2/php.ini
RUN sed -ri 's/^display_errors\s*=\s*Off/display_errors = On/g' /etc/php5/cli/php.ini
RUN sed -ri 's/^PermitRootLogin.*$/PermitRootLogin yes/g' /etc/ssh/sshd_config
RUN echo "/usr/sbin/apache2ctl -f etc/apache2/sites-available/000-default.conf" >> /etc/bash.bashrc

ADD supervisord.conf /etc/supervisor/conf.d/supervisord.conf
ADD run /usr/local/bin/
RUN chmod +x /usr/local/bin/run
EXPOSE 22 80
CMD ["/usr/local/bin/run"]

Build your docker image
 
See your images locally
 
Log into docker
 
Push your image to dockerhub
 
See your image in dockerhub
 
Go to ECS AWS console & start a cluster
 
When you get to the IAM role section, create new roles for ECS
 
Create an EC2 and ECS role as: ecsInstanceRole & ecsService Role (Autogenerated)
 
Use the new roles you created
 
Have the console launch your ECS cluster via cloudformation
 
After the cluster is launched list out our clusters on your command line.
 
Get the available instances from the cluster (Sample cluster only had one micro ec2 instance)
 
Deploy your ecs task
{
  "containerDefinitions": [
    {
      "name": "apigee",
      "image": "jdgoren/aws_ecs_api:latest",
      "essential": true,
      "portMappings": [
        {
          "containerPort": 80,
          "hostPort": 80
        }
      ],
      "memory": 500,
      "cpu": 10
    }
  ],
  "family": "apigee"
}
 
 
View the output and check if the task is available in the console.
 
Go to your clusters on ECS
 
Click Run new Task
 
Choose the task definition you just created and click Run Task
 
See your task spinning up
 
Get the IP of your microservice to see your application
 
View our sample application
 
Fill in the paramaters and click Submit
 
View the result of the PHP application which submitted the parameters to the AWS API endpoint which invoked our Python logic in our AWS Lambda function.
 
